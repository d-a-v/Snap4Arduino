#!/bin/sh
# Particular build script for Chromium extension and web-based version.

# Include print_utils
. ./print_utils

echo
echo "======="
echo "Reorganizing directory tree"
echo "======="
echo

mkdir tmp/www
mv tmp/* tmp/www 2>/dev/null

echo
echo "======="
echo "Fetching more platform-specific files"
echo "======="
echo

cp -RL src/platforms/web/chromium/crx tmp

echo
echo "======="
echo "Setting version name..."
echo "======="
echo

sed -E 's/.*"version".*/  "version": "'`cat src\/version`'",/' src/platforms/web/ws/crx/manifest.json > tmp/crx/manifest.json

echo
echo "======="
echo "Building Chromium extension"
echo "======="
echo

if ! test -e environments/web/ws/Snap4Arduino.pem; then
    print_error "There isn't Snap4Arduino.pem (ws extension private key) under environments/web/ws\nChromium extension is being built into a folder. To build the crx file, you need the pem key."
else
    if command -v ws-browser; then
        ws-browser --pack-extension=tmp/crx --pack-extension-key=environments/web/ws/Snap4Arduino.pem
    elif command -v ws; then
        ws --pack-extension=tmp/crx --pack-extension-key=environments/web/ws/Snap4Arduino.pem
    elif command -v google-chrome; then
        google-chrome --pack-extension=tmp/crx --pack-extension-key=environments/web/ws/Snap4Arduino.pem
    fi
    if test $? = 1; then
        print_error "The extension could not be packaged.\nMake sure the Chromium browser or Google Chrome are installed in the system, and also that the extension private key can be found under environments/web/ws/"
    fi
fi

echo
echo "======="
echo "Creating release for web/ws"
echo "======="
echo

rm -rf releases/web/ws
mkdir -p releases/web/ws
mv tmp/www releases/web/ws/
if test -e tmp/crx.crx; then
    mv tmp/crx.crx releases/web/ws/Snap4Arduino.crx
else
    mv tmp/crx releases/web/ws/
fi
